üìò Projet : Scraper "LBC P√©pite Hunter"
Objectif : D√©tecter automatiquement les v√©hicules sous-cot√©s (P√©pites) en filtrant les arnaques et les v√©hicules √† probl√®mes via une analyse hybride (Math√©matique + IA).
1. Strat√©gie de Sourcing (L'Entonnoir)
Nous adoptons une strat√©gie de "Chasseur" pour capturer les annonces mal r√©f√©renc√©es.
A. Le Filet Large (Configuration LBC)
Ne pas utiliser le filtre "Mod√®le" de LeBonCoin, mais la recherche textuelle dans la cat√©gorie Voiture.
URL Base : Cat√©gorie = Voitures (2) | Prix Min = 1000‚Ç¨ (√âvite les pi√®ces) | √ânergie & Bo√Æte fix√©s.
Recherche Texte : Juste le nom du mod√®le (ex: "Golf").
Ann√©e : Plage d√©finie (ex: 2013-2020).
B. Le Tamis (Filtrage Application)
Ton script applique ces filtres d√®s la r√©ception du HTML pour jeter les d√©chets.
1.
Blacklist (Trash) : Si titre contient : pneu, jante, location, recherche, accident, export, pour pi√®ce. -> POUBELLE.
2.
Whitelist (Target) : Si titre ne contient PAS le mod√®le cible ou ses variantes (ex: golf 7, golf vii, golf VII) -> POUBELLE.
2. Le Pipeline de Donn√©es (ETL)
L'ordre des op√©rations est critique pour ne pas fausser les statistiques de march√©.
1.
EXTRACT & CLEAN : Scraping, application des Black/Whitelists, normalisation des donn√©es (Km, Ann√©e, CP).
2.
ENRICHISSEMENT (IA/Regex) :
Appel Gemini 1.5 Flash (Prompt : Extraction JSON des Frais, Modifs, √âtat).
Calcul des Coeffs de Risque (K 
Arnaque
‚Äã
 , K 
Meca
‚Äã
 ).
3.
FILTRE STATISTIQUE (Veto) :
Si K 
Arnaque
‚Äã
 <0.5 (Risque arnaque) OU Prix<Seuil 
Aberrant
‚Äã
  : Exclure du calcul de cote.
4.
MATH (R√©gression) :
Calcul de la courbe de prix du march√© (Prix=f(Km,Ann 
e
Àä
 e)) uniquement sur les annonces "propres".
Segmentation par Cluster : Mod√®le + G√©n√©ration (d√©duite de l'ann√©e) + Moteur + Boite.
5.
SCORING FINAL : Calcul de la note pour toutes les annonces (m√™me les douteuses).
6.
LOAD (BDD) : Insert New / Update Price / Mark Sold.
3. L'Algorithme de Scoring (Le C≈ìur)
Le score est une Moyenne Pond√©r√©e (Attractivit√©) multipli√©e par un Indice de Fiabilit√© (R√©alit√©).
La Formule Ma√Ætresse
Score_{Final} = \underbrace{((S_{Deal} \times 0.5) + (S_{Conf} \times 0.3) + (S_{Prod} \times 0.2))}_{\text{Score Base (0-100)}} \times \underbrace{(K_{Meca} \times K_{Modif} \times K_{Arnaque})}_{\text{Indice Fiabilit√© (0.0 - 1.0)}}
A. Les 3 Piliers (Score Base)
1.
üí∞ Pilier Deal (50%) : Bas√© sur le Prix Virtuel.
Prix Virtuel = Prix Aich√© + Co√ªts R√©parations Chiffrables (Pneus, Freins, Distrib extraits par IA).
On compare ce Prix Virtuel √† la Cote March√©.
Score : 100/100 si -20% sous la cote. 50/100 si au prix.
2.
ü§ù Pilier Confiance (30%) :
Bonus : Anciennet√© > 2 ans, Profil V√©rifi√©, Longueur description, Mots cl√©s ("Factures", "Carnet").
Malus : Profil vide, Description < 10 mots.
3.
üíé Pilier Produit (20%) :
Bonus : Finition haute (S-Line, Carat), Options (Toit ouvrant), Premi√®re main.
B. Les Sanity Checks (Coefficients K)
Ce sont des multiplicateurs de r√©duction (1.0‚àíMalus). Ils sanctionnent le RISQUE (non chiffrable).
1.
K 
Meca
‚Äã
  (Risque M√©canique)
Contenu : Sympt√¥mes flous (bruit, fum√©e, tremblement), Pas de CT, Voyant moteur.
Exemple : Voyant allum√© = -0.30.
2.
K 
Modif
‚Äã
  (Risque Tuning)
Contenu : Stage 1, Reprog, Ligne directe, Kit √©thanol, Rabaissement.
Exemple : Stage 1 = -0.40.
3.
K 
Arnaque
‚Äã
  (Risque Vendeur)
Contenu : Arnaque d√©tect√©e (Mandat cash), Incoh√©rence G√©o, Profil cr√©√© hier sans avis.
Kill Switch : Si < 0.3, l'annonce est morte.
4. Stack Technique & Donn√©es
Stockage (PostgreSQL)
Utilisation de PostgreSQL pour sa capacit√© hybride (SQL pour les index/r√©gression + JSONB pour la data flexible).
Sch√©ma Table ads :
id (PK), title, price, mileage, year (Colonnes SQL classiques index√©es).
cluster_key (Varchar): ex: "GOLF7_DIESEL_AUTO_150".
raw_data (JSONB): Donn√©es brutes LBC.
ai_analysis (JSONB): Retour complet de Gemini (Frais, Options, Risques).
scores (JSONB): D√©tail des notes ( trust_score, deal_score, k_total).
status: ACTIVE, SOLD, SCAM.
IA (Gemini 1.5 Flash)
Prompt : Mode JSON strict.
Input : Titre, Prix, Km, Description.
Output attendu :
JSON
{
  "frais_chiffrables": [{"item": "pneus", "cout": 200}],
  "risques_meca": ["voyant moteur"],
  "modifications": ["stage 1"],
  "options": ["toit ouvrant"]
}

5. Gestion du Cycle de Vie (Mise √† jour)
1.
D√©marrage script : Charger tous les IDs actifs en m√©moire.
2.
Pendant le scrape :
ID inconnu -> INSERT.
ID connu + Prix identique -> Update last_seen.
ID connu + Prix diff√©rent -> UPDATE prix (Historiser l'ancien) + ALERTE BAISSE PRIX.
3.
Fin du script :
Les IDs en m√©moire qui n'ont pas √©t√© vus dans le scrape ‚Üí UPDATE status = 'SOLD'.